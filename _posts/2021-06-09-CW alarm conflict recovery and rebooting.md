
---

title:  "AWS 인스턴스 장애 경보 재부팅과 회복 충돌"

search: true
categories: 
  - AWS management diary
---




재부팅과 복원 작업 간에 경합 상태가 발생하지 않도록 하려면 재부팅 경보와 복원 경보에 동일한 평가 기간 값을 설정하지 마십시오. 재부팅 경보를 각각 1분의 평가 기간 3회로 설정하는 것이 좋습니다. 자세한 내용은 Amazon CloudWatch 사용 설명서의 경보 평가를 참조하세요.

최근 AWS 하드웨어에 문제가 생겨 장애가 발생했었다. 

원인은 본인들도 파악이 안된다고 한다.....

(흠 그럼 클라우드 와치 지표에서 하드웨어 문제만 따로 표시하는 건 어떻게 하는거지?)

암튼 그래서 하드웨어 장애시 복구하는 방법을 추가해야 하는 상황이 생겼다.

알아보니 클라우드 와치 경보에서 복구를 지원해 준다고 한다. 

[인스턴스를 중지, 종료, 재부팅 또는 복구하는 경보 만들기](https://docs.aws.amazon.com/ko_kr/AWSEC2/latest/WindowsGuide/UsingAlarmActions.html#AddingRebootActions)

근데 문제가 하나 생겼다. 예전부터 장애가 발생하면 재부팅 하는 경보를 추가했었는데 이게 같은 시간으로 설정을 하면 충돌이 생길 수도 있다는 것이다. 

왜냐하면 하드웨어 장애가 발생하면 SystemFailed_system지표와 unhealthy 수치가 같이 올라가기 때문이다.

안 그래도 재부팅도 unhealthy를 가지고 하는데 둘 다 동시에 발생하면 어찌 되겠나....

그래서 시간을 다르게 설정을 해둬야 한다는데 요거를 어떻게 다르게 해야할 지가 문제인 것이다. 

테스트를 하기에는 장애를 일으키기가 어렵고 또 어떤 기준으로 해야할 지 사례도 없고 말이다....

AWS측에 물어보니 기본적으로 복구의 평가기간이 부팅의 평가기간보다는 적어야 하고 평가기간의 기준은 사용자 서비스마다 다르기에 테스트를 해야한다고 답변이 왔다.

그럼 테스트를 어떻게 해야 할까? 사실 이게 문제다. 결과적으로 말하면 정확하게 테스트 하는 방법이 없다. 

복구를 할라면 하드웨어 장애를 인위적으로 일으켜야 하는데 이건 불가능하다고 한다. 

그럼 그나마 할 수 있는 방법은 부하테스트 방법으로 인스턴스 상태검사 실패 정도이다. 

쉘 스크립트나 아님 stress 프로그램을 다운 받아 CPU를 극한적으로 끌어 올리면 상태검사 실패가 가능하다

[연결할 수 없는 EC2 Linux 인스턴스의 상태 확인 실패 문제 해결](https://aws.amazon.com/ko/premiumsupport/knowledge-center/system-reachability-check/)